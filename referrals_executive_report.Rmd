---
output:
  html_document:
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
    fig_width: 7
    fig_height: 6
---


<style type="text/css">
div.main-container {
  max-width: 1800px;
  margin-left: 50px;
  margin-right: 50px;
}
</style>

<style>
.tocify {
color: black;
max-width: 400px;
margin-right: -50px;
}
.tocify .tocify-header {
    position: fixed;
    <!-- top: 50px; -->
    margin-right: 0px;
    <!-- right: -50px; -->
    width: 350px;
    border: solid 3px black;
    height: 200px;
 border: none;
}
.tocify .tocify-header .active {
color: white;
background: #d80b8c;
font-weight: bold;
}
<!-- .tocify .tocify-item { -->
<!-- background: white; -->
<!-- color: black; -->
<!--  border: none; -->
<!-- } -->
</style>


<style>
  .nav-pills>li>a:hover, .nav-pills>li>a:focus, .nav-pills>li.active>a,     .nav-pills>li.active>a:hover, .nav-pills>li.active>a:focus{
     background-color: #212070;
     }
</style>


<style>
.container { width: 1800px; }
h2 {
  background-color: #dddedd;
  color: black;
  text-indent: 20px;
  <!-- font-weight: bold; -->
}
h3 {
  background-color: #f2f2f2;
  color: black;
  text-indent: 20px;
  <!-- font-weight: bold; -->
}
h4 {
  <!-- background-color: #dddedd; -->
  <!-- color: black; -->
  text-indent: 50px;
  <!-- font-weight: bold; -->
}
</style>


<style>
.blackbox {
  padding: 1em;
  background: white;
  color: black;
  border: 2px solid #7f7f7f;
  width: 100%;
  position: center;
  align: center;
  margin: 0px auto;
}
.center {
  text-align: left;
  margin: 0px auto;
}
</style>

<style>
.my_div_class {
  color: black;     
  font-size: 12px; 
  font-style: italic;
}
</style>
<!-- ```{css toc-content, echo = FALSE} -->
<!-- #TOC { -->
<!--   right: 0px; -->
<!--   margin: 20px -50px 25px 0px; -->
<!-- } -->

<!-- .main-container { -->
<!--     margin-left: 0px; -->
<!-- } -->
<!-- ``` -->


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```


```{r Load Packages, echo = FALSE, warning = FALSE, message = FALSE}

# # Load packages -----------------------------------------------------------------------------------
suppressMessages({
  memory.limit(size = 8000000)
  library(readxl)
  library(writexl)
  library(plyr)
  library(dplyr)
  library(data.table)
  library(zoo)
  library(shiny)
  library(shinydashboard)
  library(shinydashboardPlus)
  library(shinyWidgets)
  library(htmlwidgets)
  library(lubridate)
  library(tcltk)
  library(tidyverse)
  library(plotly)
  library(knitr)
  library(kableExtra)
  library(leaflet)
  library(grid)
  library(gridExtra)
  library(eeptools)
  library(ggQC)
  library(zipcodeR)
  library(utils)
  library(scales)
  library(chron)
  library(bupaR)
  library(shiny)
  library(DT)
  library(DiagrammeR)
  library(shinyalert)
  library(edeaR)
  library(processmapR)
  library(processmonitR)
  library(processanimateR)
  library(tidyr)
  library(lubridate)
  library(RColorBrewer)
  library(DiagrammeR)
  library(ggplot2)
  library(leaflet)
  library(readr)
  library(highcharter)
  library(ggforce) # for 'geom_arc_bar'
  library(packcircles) # for packed circle graph
  library(viridis)
  library(ggiraph)
  library(treemapify)
  library(treemap)
  library(broom)
  library(extrafont)
  library(tis) # for US holidays
  library(vroom)
  library(sjmisc)
  library(tools)
  library(here)
  library(shinyBS)
  library(shinyscreenshot)
  library(fasttime)
  library(shinycssloaders)
  library(feather)
  # library(zipcodeR)
  library(formattable)
  library(shinyjs)
  library(janitor)
  library(patchwork)
  library(flexdashboard)
  # library(tidyverse)
  # library(viridis)
  # library(hrbrthemes)
  # library(plotly)
  # install.packages("bsts")
  library(bsts)
  library(reactable)
  # install.packages("reactablefmtr")
  library(reactablefmtr)
  library(svDialogs)
  # library(openxlsx)
  library(flextable)
  library(officedown)
  library(officer)
  library(magrittr)
  library(webshot) 
  library(png)
  library(ggh4x)
  library(RODBC)
  library(DBI)
  library(odbc)
  library(dbplyr)
  library(pool)
  library(emojifont)
})


```


```{r Graph asthetics, echo = FALSE, warning = FALSE, message = FALSE}
### Color Functions for Graphs ============================================================

# Mount Sinai corporate colors "USE THIS TO ADD COLORS"
MountSinai_colors <- c(
  `dark purple`  = "#212070",
  `dark pink`    = "#d80b8c",
  `dark blue`    = "#00aeef",
  `dark grey`    = "#7f7f7f",
  `yellow`       = "#ffc000",
  `purple`       = "#7030a0",
  `med purple`   = "#5753d0",
  `med pink`     = "#f75dbe",
  `med blue`     = "#5cd3ff",
  `med grey`     = "#a5a7a5",
  `light purple` = "#c7c6ef",
  `light pink`   = "#fcc9e9",
  `light blue`   = "#c9f0ff",
  `light grey`   = "#dddedd"
  )

# Function to extract Mount Sinai colors as hex codes
# Use Character names of MountSinai_colors

MountSinai_cols <- function(...) {
  cols <- c(...)
  
  if (is.null(cols))
    return (MountSinai_colors)
  
  MountSinai_colors[cols]
}

# Color Function that can be used to call all colors is "MountSinai_cols()"
# Use in ggplot 

  #MountSinai_cols()       # will provide all colors and their hex codes in a table 
  #MountSinai_cols("pink") # will provide color name and the hex code for the pink color

# Create palettes 
MountSinai_palettes <- list(
  `all`   = MountSinai_cols("dark purple","dark pink","dark blue","dark grey",
                            "med purple","med pink","med blue","med grey", 
                            "light purple","light pink","light blue","light grey"),
  
  `main`  = MountSinai_cols("dark purple","dark pink","dark blue","dark grey"),
  
  `purple`  = MountSinai_cols("dark purple","med purple","light purple"),
  
  `pink`  = MountSinai_cols("dark pink","med pink","light pink"),
  
  `blue`  = MountSinai_cols("dark blue", "med blue", "light blue"),
  
  `grey`  = MountSinai_cols("dark grey", "med grey", "light grey"),
  
  `purpleGrey` = MountSinai_cols("dark purple", "dark grey"),
  
  `pinkBlue` = MountSinai_cols("dark pink", "dark blue")
  
)

# MountSinai_palettes
# Return function to interpolate a Mount Sinai color palette
# default value is the main palette, reverse = True will change the order

MountSinai_pal <- function(palette = "all", reverse = FALSE, ...) {
  pal <- MountSinai_palettes[[palette]]
  
  if (reverse) pal <- rev(pal)
  
  colorRampPalette(pal, ...)
}



# Scale Function for ggplot can be used instead of scale_color_manual
scale_color_MountSinai <- function(palette = "all", discrete = TRUE, reverse = FALSE, ...) {
  pal <- MountSinai_pal(palette = palette, reverse = reverse)
  
  if (discrete) {
    discrete_scale("colour", paste0("MountSinai_", palette), palette = pal, ...)
  } else {
    scale_color_gradientn(colours = pal(256), ...)
  }
}

# Scale Fill for ggplot insetead of scale_fill_manual 
scale_fill_MountSinai <- function(palette = "all", discrete = TRUE, reverse = FALSE, ...) {
  pal <- MountSinai_pal(palette = palette, reverse = reverse)

  if (discrete) {
    discrete_scale("fill", paste0("MountSinai_", palette), palette = pal, ...)
  } else {
    scale_fill_gradientn(colours = pal(256), ...)
  }
}

# Use in ggplot 
  # scale_color_MountSinai("main")

```


```{r Global Functions, echo = FALSE, warning = FALSE, message = FALSE}

'%!in%' <- function(x,y)!('%in%'(x,y)) # Does not include
not_all_na <- function(x) all(!is.na(x)) # Exclude columns with All NAs

```


```{r Reporting Variables, echo = FALSE, warning = FALSE, message = FALSE}

report_run_date <- Sys.Date()
# report_run_date <- "2022-08-10"
reporting_week <- floor_date(as.Date(report_run_date, "%Y-%m-%d")-7, unit="week", week_start = 7)
reporting_week_prior <- floor_date(as.Date(report_run_date, "%Y-%m-%d")-14, unit="week", week_start = 7)
reporting_week_next <- floor_date(as.Date(report_run_date, "%Y-%m-%d"), unit="week", week_start = 7)

reporting_year <- format(as.Date(report_run_date), "%Y")
reporting_month <- format(as.Date(report_run_date), "%b")
reporting_monthNum <- format(as.Date(report_run_date), "%m")


```


```{r Referrals Data Importing, echo = FALSE, warning = FALSE, message = FALSE}

# Connect to Database ----------------------------------------------------------
# conn1 <- odbcConnect("Caboodle") # Connect to Server

conn1 <- dbPool(drv = odbc(), dsn = "Caboodle", timeout = 30)

# Import Referrals+Visit Data --------------------------------------------------
# referrals_raw <- sqlQuery(conn1, "SELECT * FROM PRDREPORT.FullAccess.Referrals") # Master Referrals Data
referrals_conn <- tbl(conn1, "Referrals")
referrals_raw <- referrals_conn %>%
  mutate(StartInstant = as.Date(StartInstant)) %>%
  filter(StartInstant >= as.Date("2022-04-01") & StartInstant <= report_run_date) %>%
  filter(Status != "Canceled") %>%
  collect()

# Import Referrals Data for Addtional Referral Details -------------------------
# referralFactAll <- sqlQuery(conn1, "SELECT TOP 10* FROM PRDREPORT.FullAccess.ReferralFact")
referralFact_conn <- tbl(conn1, "ReferralFact")

referralFact_raw <- referralFact_conn %>%
  mutate(StartInstant = as.Date(StartInstant)) %>%
  filter(StartInstant >= as.Date("2022-04-01") & StartInstant <= report_run_date) %>%
  group_by(ReferralKey, StartInstant, `_CreationInstant`, `_LastUpdatedInstant`, LastEnteredWorkqueueDateKey_X,
           LastEnteredWorkqueueTimeKey_X, LastEnteredWorkqueueName_X,
           Class, Priority, Redirected, Rejected, TriageRejectionReason, InAnyWorkqueue, StatusReason, SchedulingStatus,
           FirstCallMadeInstant, FirstEncounterCreatedInstant, FirstEncounterInstant, ExpirationInstant,
           WasPatientContactedWithin12Hours_X,
           ProfessionalChargeAmount, ProfessionalChargeEstimate, HospitalChargeEstimate) %>%
  summarise(total = n()) %>%
  collect() 

referralFact_raw$total <- NULL

# referralFact_all <- referralFact_conn %>%
#   mutate(StartInstant = as.Date(StartInstant)) %>%
#   filter(StartInstant == as.Date("2022-11-03")) %>%
#   collect()

# visitFact_conn <- tbl(conn1, "VisitFact")
# visitFact_raw <- visitFact_conn %>%
#   filter(AppointmentStatus == "Arrived") %>%
#   filter(!is.na(PaymenetDue)) %>%
#   head(10000) %>%
#   collect()
# referral_fact_all <- sqlQuery(conn1, "SELECT TOP 200 * FROM PRDREPORT.FullAccess.ReferralFact ORDER BY StartInstant")

# Append Additional Referral Columns -------------------------------------------
referrals_merged <- left_join(referrals_raw, subset(referralFact_raw, select = -c(StartInstant, Priority)))
referrals_merged <- referrals_merged %>%
  mutate(SentByDepID = as.character(SentByDepID),
         ReceivedByDepID = as.character(ReceivedByDepID))

```


```{r Referral WQ Data Import, echo = FALSE, warning = FALSE, message = FALSE}

# Import WQ Data ---------------------------------------------------------------
wq_history_conn <- tbl(conn1, "ReferralWorkqueueEventFactX")
wq_reasons_conn <- tbl(conn1, "ReferralWQReasons")

```


```{r Referrals Data Processing, echo = FALSE, warning = FALSE, message = FALSE}

# Referrals Raw Data Processing ------------------------------------------------
## Priority Groups =============================================================
referrals_merged <- referrals_merged %>%
  mutate(createdWeek = floor_date(as.Date(StartInstant, "%Y-%m-%d"), unit="week", week_start = 7),
         createdYear = format(as.Date(StartInstant, "%Y-%m-%d"),"%Y"),
         createdMonNum = as.numeric(format(as.Date(StartInstant, "%Y-%m-%d"),"%m")),
         createdMonth = format(as.Date(StartInstant, "%Y-%m-%d"),"%B"),
         createdMonthYear = format(as.Date(StartInstant, "%Y-%m-%d"),"%m-%Y")) %>%
  mutate(priority_type = case_when(str_detect(toupper(Priority), "CONVENIENCE") ~ "Patient Convenience"
                                   ,str_detect(toupper(Priority), "2 DAYS") ~ "Within 2 Days"
                                   ,str_detect(toupper(Priority), "1 WEEK") ~ "Within 1 Week"
                                   ,str_detect(toupper(Priority), "2 WEEKS") ~ "Within 2 Weeks"
                                   ,str_detect(toupper(Priority), "3-6 Days") ~ "Within 1 Week" # Question: Should this be a separate category?
                                   ,str_detect(toupper(Priority), "7-14 Days") ~ "Within 2 Weeks"
                                   ,Priority == "Routine" ~ "Routine"
                                   , TRUE ~ "Not Specified"))

```


```{r Unique Referral Volume Data, echo = FALSE, warning = FALSE, message = FALSE}

# Unique Referrals by Appointment Status -------------------------------------------------------
referrals_processed <- referrals_merged %>%
  group_by(ReferralKey) %>%
  mutate(ApptStatusFinal = NA) %>%
  mutate(ApptStatusFinal = case_when((is.na(ApptStatusFinal) & any(AppointmentStatus %in% c("Arrived","Completed"))) ~ "Arrived"
                                     ,(is.na(ApptStatusFinal) & any(AppointmentStatus %in% c("No Show", "Left without seen"))) ~ "No Show"
                                     ,(is.na(ApptStatusFinal) & any(AppointmentStatus == "Canceled")) ~ "Canceled"
                                     ,(is.na(ApptStatusFinal) & any(AppointmentStatus %in% c("Scheduled","Confirmed"))) ~ "Scheduled"
                                     ,TRUE ~ "Pending"))


# Unique Referral Volume by Appointment Status -------------------------------------------------
referral_vol <- referrals_processed %>%
  group_by(SentBySite, SentByDepID, SentByDept, SentBySpecialty,  
           ReceivedBySite, ReceivedByDepID, ReceivedByDept, ReceivedBySpecialty,
           StartInstant, createdYear, createdMonthYear, createdMonNum, createdMonth, createdWeek, ReferralKey, ReferralEpicId, priority_type, ApptStatusFinal, 
           Class, WasPatientContactedWithin12Hours_X, CreationToFirstEncounterDate, ExpirationInstant,
           ProfessionalChargeEstimate, HospitalChargeEstimate, Redirected, Rejected, TriageRejectionReason, InAnyWorkqueue,
           Patient_MRN, ICD_10_Chosen, 
           Status, CloseReason, SchedulingStatus) %>%
  summarise(total = n()) %>%
  mutate(SentBySpecialty = case_when(SentByDept %in% c("MS EPICCARE LINK","MS RYAN CENTER LINK") ~ "ECL"
                                # ,str_detect(toupper(SentByDept), "EMERGENCY") ~ "ED"
                                # ,SentByDept == "EMERGENCY DEPARTMENT PSYCH" ~ "ED Psych"
                                # ,SentByDept == "CPEP PSYCH ED BI" ~ "ED Psych"
                                , TRUE ~ SentBySpecialty)) %>%
  mutate(SentBySite = case_when(SentByDept %in% c("MS EPICCARE LINK","MS RYAN CENTER LINK") ~ "ECL"
                                     # ,SentByDept == "EMERGENCY DEPT BI" ~ "MSBI"
                                     # ,SentByDept == "EMERGENCY DEPT MORNINGSIDE" ~ "MSM"
                                     # ,SentByDept == "EMERGENCY DEPT WEST" ~ "MSW"
                                     # ,SentByDept == "EMERGENCY DEPARTMENT" ~ "MSH"
                                     # ,SentByDept == "EMERGENCY DEPT QUEENS" ~ "MSQ"
                                     # ,SentByDept == "EMERGENCY DEPT BI BROOKLYN" ~ "MSB"
                                     # ,SentByDept == "EMERGENCY DEPARTMENT PSYCH" ~ "MSH"
                                     # ,SentByDept == "CPEP PSYCH ED BI" ~ "MSBI"
                                     ,TRUE ~ SentBySite))

referral_vol$referral_age <- difftime(report_run_date, as.Date(referral_vol$StartInstant, "%Y-%m%-%d"), units = "days")
  
```


```{r 32BJ Volume,  echo = FALSE, warning = FALSE, message = FALSE}

# sent_vol_32bj <- referral_vol %>%
#   filter(IS32BJ_YN == "Y") %>%
#   group_by(createdMonthYear, SentBySpecialty) %>%
#   summarise(total_sent = n())
# 
# receiving_vol_32bj <- referral_vol %>%
#   filter(IS32BJ_YN == "Y") %>%
#   group_by(createdMonthYear, ReceivedBySpecialty) %>%
#   summarise(total_received = n())
# 
# write.xlsx(sent_vol_32bj, "/SharedDrive/deans/Presidents/SixSigma/Individual Folders/Current Employees/Engineers/So Youn Kweon/server-upload/32BJ Referral Sent Volume.xlsx")
# write.xlsx(receiving_vol_32bj, "/SharedDrive/deans/Presidents/SixSigma/Individual Folders/Current Employees/Engineers/So Youn Kweon/server-upload/32BJ Referral Received Volume.xlsx")
```


```{r WQ Data Processing, echo = FALSE, warning = FALSE, message = FALSE}

# Subset WQ History Data based on Referrals Data -------------------------------
wq_history_merged <- left_join(referral_vol[,c("ReferralKey", "ReferralEpicId", "Status", "SchedulingStatus", "InAnyWorkqueue", "priority_type")], 
                               wq_history_conn %>% 
                                 filter(ReferralKey >= 0) %>%
                                 # filter(ReferralType %in% c("TO","FROM")) %>% # Remove unspecified wq types 
                                 filter(`_CreationInstant` >= as.Date("2022-04-01")) %>%
                                 collect())

wq_history_merged <- wq_history_merged %>% 
  filter(!is.na(EventDateKey)) %>%
  mutate(EventDate = as.Date(lubridate::ymd(EventDateKey)),
         EventTime = paste0(" ",sub('(\\d{2})$', ':\\1', EventTimeKey)),
         EventTime = gsub(" :", "00:", EventTime),
         EventTime = gsub(" ","",EventTime),
         releaseDate = as.Date(lubridate::ymd(ReleaseDateKey))) %>%
  mutate(EventDateTime = as.POSIXct(paste(EventDate, EventTime), format="%Y-%m-%d %H:%M"))

wq_history_merged$releaseDate <- case_when(is.na(wq_history_merged$releaseDate) ~ Sys.Date(),
                                           TRUE ~ wq_history_merged$releaseDate) 


wq_history_merged <- wq_history_merged %>%
  arrange(EventDateTime, releaseDate) %>%
  arrange(ReferralKey) %>%
  group_by(ReferralKey, EpicWorkqueueId, releaseDate) %>%
  mutate(ID = seq_len(n())) %>%
  mutate(wq_entered = min(EventDateTime),
         wq_exited = max(releaseDate),
         wq_latest_reason = case_when(EventDateTime == wq_entered & releaseDate == wq_exited ~ ReferralWorkqueueReason,
                                      TRUE ~ ""))


# Unique WQ Volume Data with WQ Entered and Existed Times
wq_volume_data <- wq_history_merged %>%
  filter(wq_latest_reason != "") %>%
  group_by(ReferralKey, ReferralEpicId, InAnyWorkqueue, ReferralType, EpicWorkqueueId, wq_entered, wq_exited, wq_latest_reason) %>%
  summarise(referral_type = n()) %>%
  mutate(wq_entered = format(as.Date(wq_entered, "%Y-%m-%d %HH:%MM:%SS"),"%Y-%m-%d %HH:%MM:%SS"),
         wq_enteredWeek = floor_date(as.Date(wq_entered, "%Y-%m-%d %HH:%MM:%SS"), unit="week", week_start = 7),
         wq_enteredYear = format(as.Date(wq_entered, "%Y-%m-%d %HH:%MM:%SS"),"%Y"),
         wq_enteredMonNum = as.numeric(format(as.Date(wq_entered, "%Y-%m-%d %HH:%MM:%SS"),"%m")),
         wq_enteredMonth = format(as.Date(wq_entered, "%Y-%m-%d %HH:%MM:%SS"),"%B"),
         wq_enteredMonthYear = format(as.Date(wq_entered, "%Y-%m-%d %HH:%MM:%SS"),"%m-%Y"),
         wq_enteredDay = format(as.Date(wq_entered, "%Y-%m-%d %HH:%MM:%SS"),"%A")) %>%
  mutate(wq_exitedWeek = floor_date(as.Date(wq_exited, "%Y-%m-%d"), unit="week", week_start = 7),
         wq_exitedYear = format(as.Date(wq_exited, "%Y-%m-%d"),"%Y"),
         wq_exitedMonNum = as.numeric(format(as.Date(wq_exited, "%Y-%m-%d"),"%m")),
         wq_exitedMonth = format(as.Date(wq_exited, "%Y-%m-%d"),"%B"),
         wq_exitedMonthYear = format(as.Date(wq_exited, "%Y-%m-%d"),"%m-%Y"),
         wq_exitedDay = format(as.Date(wq_exited, "%Y-%m-%d"),"%A")) %>%
  mutate(wq_latest_reason = toupper(wq_latest_reason)) %>%
  mutate(reason_type = case_when(ReferralType == "FROM" & str_detect(wq_latest_reason, "DEACTIVATED OR INVALID|NO DEPT|WTC NEED") ~ "Missing department",
                                 ReferralType == "FROM" & str_detect(wq_latest_reason, "OUTGOING") ~ "Outgoing Referral needs scheduling",
                                 ReferralType == "FROM" & str_detect(wq_latest_reason, "TRIAGE") ~ "Triage rejected",
                                 ReferralType == "FROM" & str_detect(wq_latest_reason, "PSYCH") ~ "Psych referrals",
                                 ReferralType == "TO" & str_detect(wq_latest_reason, "NEEDS SCHEDULING|NEEDS TO BE WORKED|INCOMING REFERRAL NEEDS AUTH") 
                                 ~ "Both scheduling and authorization outstanding",
                                 ReferralType == "TO" & str_detect(wq_latest_reason, "AUTHORIZED AND NEED SCHEDULING|NEED SCHEDULING") ~ "Authorized but scheduling needed",
                                 ReferralType == "TO" & str_detect(wq_latest_reason, "NEED AUTHORIZATION|NO AUTHORIZATION|INVALID AUTH NUMBER") ~ "Authorization needed",
                                 ReferralType == "TO" & str_detect(wq_latest_reason, "UNABLE TO CONTACT") ~ "Unable to Contact Patient",
                                 ReferralType == "TO" & str_detect(wq_latest_reason, " RFL INVALID AUTH NUMBER|W/O LINKED REFERRAL") ~ "Scheduled but Authorization is outstanding",
                                 TRUE ~ "Other"
                                 ))
wq_volume_data$wq_entered <- format(as.Date(wq_volume_data$wq_entered, "%Y-%m-%d %HH:%MM:%SS"),"%Y-%m-%d")
wq_volume_data$referral_age <- difftime(wq_volume_data$wq_exited, as.Date(wq_volume_data$wq_entered, "%Y-%m-%d"), units = "days")

# wq_volume_data$ wq_enteredDay <- format(as.Date(wq_volume_data$wq_entered, "%Y-%m-%d %HH:%MM:%SS"),"%A")
# wq_volume_data$wq_exitedDay = format(as.Date(wq_volume_data$wq_exited, "%Y-%m-%d"),"%A")
# wq_volume_data$wq_entered <- format(as.Date(wq_volume_data$wq_entered, "%Y-%m-%d %HH:%MM:%SS"),"%Y-%m-%d")
  
```


```{r WQ Reasons Processing, echo = FALSE, warning = FALSE, message = FALSE}

wq_reasons_raw <- wq_reasons_conn %>%
  collect() %>%
  mutate(wq_type = case_when(str_detect(WorkqueueName, " TO ") ~ "TO",
                             str_detect(WorkqueueName, " FROM ") ~ "FROM",
                             str_detect(WorkqueueName, "TRIAGE") ~ "TRIAGE",
                             str_detect(WorkqueueName, "AUTHORIZATION REQUIRED") ~ "AUTHORIZATION",
                             str_detect(WorkqueueName, "PAS") ~ "PAS",
                             TRUE ~ ""))

## WQ Reasons Grouping ---------------------------------------------------------
wq_reasons_raw <- wq_reasons_raw %>%
  mutate(ReferralWorkqueueReason = toupper(ReferralWorkqueueReason)) %>%
  mutate(reason_type = case_when(wq_type == "FROM" & str_detect(ReferralWorkqueueReason, "DEACTIVATED OR INVALID|NO DEPT|WTC NEED") ~ "Missing Department",
                                 wq_type == "FROM" & str_detect(ReferralWorkqueueReason, "OUTGOING") ~ "Outgoing Referral Needs Scheduling",
                                 wq_type == "FROM" & str_detect(ReferralWorkqueueReason, "TRIAGE") ~ "Triage Rejected",
                                 wq_type == "FROM" & str_detect(ReferralWorkqueueReason, "PSYCH") ~ "Psych Referrals",
                                 wq_type == "TO" & str_detect(ReferralWorkqueueReason, "AUTHORIZED AND NEED SCHEDULING|NEED SCHEDULING") ~ "Authorized but Scheduling Needed",
                                 wq_type == "TO" & str_detect(ReferralWorkqueueReason, "NEED AUTHORIZATION|NO AUTHORIZATION") ~ "Authorization Needed",
                                 wq_type == "TO" & str_detect(ReferralWorkqueueReason, "UNABLE TO CONTACT") ~ "Unable to Contact Patient",
                                 TRUE ~ "Other"
                                 )) %>%
  mutate(creation_date = as.Date(lubridate::ymd(CreationDateKey)),
         entry_date = as.Date(lubridate::ymd(EntryDateKey))) %>%
  mutate(days_since_creation = difftime(Sys.Date(), creation_date, units = "days"),
         days_wq = difftime(Sys.Date(), entry_date, units = "days"))


wq_reasons_raw$priority_type <- referral_vol$priority_type[match(wq_reasons_raw$ReferralEpicId, referral_vol$ReferralEpicId)]
wq_reasons_raw$WasPatientContactedWithin12Hours_X <- referral_vol$WasPatientContactedWithin12Hours_X[match(wq_reasons_raw$ReferralEpicId, referral_vol$ReferralEpicId)]


# library(plyr)
# duplicated_rows <- ddply(wq_reasons_raw,.(ReferralEpicId),nrow)

wq_reasons_raw <- wq_reasons_raw %>%
  distinct()

```


```{r Graph and Table Functions, echo = FALSE, warning = FALSE, message = FALSE, results='hide'}

# Creating Data Bars for Reactable ---------------------------------------------
 library(htmltools)
  bar_style <- function(width = 1, fill = "#e6e6e6", height = "75%",
                      align = c("left", "right"), color = NULL) {
  align <- match.arg(align)
  if (align == "left") {
    position <- paste0(width * 100, "%")
    image <- sprintf("linear-gradient(90deg, %1$s %2$s, transparent %2$s)", fill, position)
  } else {
    position <- paste0(100 - width * 100, "%")
    image <- sprintf("linear-gradient(90deg, transparent %1$s, %2$s %1$s)", position, fill)
  }
  list(
    backgroundImage = image,
    backgroundSize = paste("100%", height),
    backgroundRepeat = "no-repeat",
    backgroundPosition = "center",
    color = color
  )
  }
  
# Creating Value Boxes (3 per row) ---------------------------------------------
  createValueBoxes <- function(df, box_color, h = 8, w = 14, padding=0.5, rows = 2){
  # required packages
  library(ggplot2)
  library(emojifont)
  # verify our inputs
  if (!is.data.frame(df)) {
    stop(paste("Argument", deparse(substitute(df)), "must be a data.frame."))
    }
  if(!all(i <- rlang::has_name(df,c("values", "infos", "icons")))){
    stop(sprintf(
      "%s does not contain: %s",
      deparse(substitute(df)),
      paste(columns[!i], collapse=", ")))
  }
  
  boxes = nrow(df) # number of items passed
  # calculate the grid
  cols = boxes/rows
  plotdf <- data.frame(
    x = rep(seq(0, (w+padding)*cols-1, w+padding), times=rows),
    y = rep(seq(0, (h+padding)*rows-1, h+padding), each=cols),
    h = rep(h, boxes),
    w = rep(w, boxes),
    value = df$values,
    info = df$infos,
    icon = fontawesome(df$icons),
    font_family = c(rep("fontawesome-webfont", boxes)),
    color = factor(1:boxes)
  )
  print(plotdf)
  ggplot(plotdf, aes(x, y, height = h, width = w, label = info)) +
    ## Create the tiles using the `color` column
    geom_tile(aes(fill = color)) +
    ## Add the numeric values as text in `value` column
    geom_text(color = "white", fontface = "bold", size = 18,
              aes(label = value, x = x - w/2.2, y = y + h/4), hjust = 0) +
    ## Add the labels for each box stored in the `info` column
    geom_text(color = "white", fontface = "bold", size = 12,
              aes(label = info, x = x - w/2.2, y = y-h/4), hjust = 0) +
    coord_fixed() +
    scale_fill_manual(values = c(rep(box_color,3)))+
    ## Use `geom_text()` to add the icons by specifying the unicode symbol.
    geom_text(size = 24, aes(label = icon, family = font_family,
                             x = x + w/4, y = y + h/8), alpha = 0.25) +
    theme_void() +
    guides(fill = FALSE)
  
  } 
  
  
  # Creating Value Boxes (2 per row) ---------------------------------------------
  createValueBoxes_2boxes <- function(df, box_color, h = 8, w = 14, padding=0.5, rows = 2){
  # required packages
  library(ggplot2)
  library(emojifont)
  # verify our inputs
  if (!is.data.frame(df)) {
    stop(paste("Argument", deparse(substitute(df)), "must be a data.frame."))
    }
  if(!all(i <- rlang::has_name(df,c("values", "infos", "icons")))){
    stop(sprintf(
      "%s does not contain: %s",
      deparse(substitute(df)),
      paste(columns[!i], collapse=", ")))
  }
  
  boxes = nrow(df) # number of items passed
  # calculate the grid
  cols = boxes/rows
  plotdf <- data.frame(
    x = rep(seq(0, (w+padding)*cols-1, w+padding), times=rows),
    y = rep(seq(0, (h+padding)*rows-1, h+padding), each=cols),
    h = rep(h, boxes),
    w = rep(w, boxes),
    value = df$values,
    info = df$infos,
    icon = fontawesome(df$icons),
    font_family = c(rep("fontawesome-webfont", boxes)),
    color = factor(1:boxes)
  )
  print(plotdf)
  ggplot(plotdf, aes(x, y, height = h, width = w, label = info)) +
    ## Create the tiles using the `color` column
    geom_tile(aes(fill = color)) +
    ## Add the numeric values as text in `value` column
    geom_text(color = "white", fontface = "bold", size = 18,
              aes(label = value, x = x - w/2.2, y = y + h/4), hjust = 0) +
    ## Add the labels for each box stored in the `info` column
    geom_text(color = "white", fontface = "bold", size = 12,
              aes(label = info, x = x - w/2.2, y = y-h/4), hjust = 0) +
    coord_fixed() +
    scale_fill_manual(values = c(rep(box_color,3)))+
    ## Use `geom_text()` to add the icons by specifying the unicode symbol.
    geom_text(size = 24, aes(label = icon, family = font_family,
                             x = x + w/4, y = y + h/8), alpha = 0.25) +
    theme_void() +
    guides(fill = FALSE)
  
  } 

# Formatting Dollar/big Number Values -------------------------------------------
  comprss <- function(tx) { 
      div <- findInterval(as.numeric(gsub("\\,", "", tx)), 
         c(0, 1e3, 1e6, 1e9, 1e12) )  # modify this if negative numbers are possible
      paste(round( as.numeric(gsub("\\,","",tx))/10^(3*(div-1)), 2), 
           c("","K","M","B","T")[div] )}
  
# Reactable Conditional Formatting ---------------------------------------------
  
  make_color_pal <- function(colors, bias = 1) {
  get_color <- colorRamp(colors, bias = bias)
  function(x) rgb(get_color(x), maxColorValue = 255)
  }
  
  pct_colorGn <- make_color_pal(c("#ffffff", "#f2fbd2", "#c9ecb4", "#93d3ab", "#35b0ab"), bias = 2)
  pct_color_GnRd <- make_color_pal(c("#fd84a9", "white", "#85e085"), bias = 2)

```


```{r YTD Snapshot Referrals, echo = FALSE, warning = FALSE, message = FALSE}

# Referrals Snapshot 
## 1. Total Referrals Created YTD
referral_received_ytd <- referral_vol %>%
  filter(createdYear == reporting_year) %>%
  filter(Class != "Outgoing") %>%
  group_by(createdYear) %>%
  summarise(total =n())

## Estimated Revenue Generated from Arrived Referrals
referral_est_rev_ytd <- referral_vol %>%
  filter(createdYear == reporting_year) %>%
  filter(Class != "Outgoing") %>%
  filter(ApptStatusFinal == "Arrived") %>%
  # filter(ApptStatusFinal == "Pending" & as.Date(ExpirationInstant, "%Y-%m-%d") < report_run_date) %>%
  group_by(createdYear) %>%
  summarise(total = n(),
            total_prof_charge_est = sum(ProfessionalChargeEstimate, na.rm = T),
            total_hosp_charge_est = sum(HospitalChargeEstimate, na.rm = T))

## Total Referrals Expired + Missed Professional Revenue + Missed Technical Revenue
referral_expired_ytd <- referral_vol %>%
  filter(createdYear == reporting_year) %>%
  filter(ApptStatusFinal == "Pending" & referral_age >180) %>%
  # filter(ApptStatusFinal == "Pending" & as.Date(ExpirationInstant, "%Y-%m-%d") < report_run_date) %>%
  group_by(createdYear) %>%
  summarise(total = n(),
            total_prof_charge_est = sum(ProfessionalChargeEstimate, na.rm = T),
            total_hosp_charge_est = sum(HospitalChargeEstimate, na.rm = T))

## 2 & 3. % of Incoming and Outgoing Referrals
referral_vol_class_ytd <- referral_vol %>%
  filter(createdYear == reporting_year) %>%
  group_by(Class) %>%
  summarise(total = n()) %>%
  mutate(perc = total/sum(total)) %>%
  filter(Class != "Internal") %>%
  dplyr::select(Class, perc) %>%
  pivot_wider(names_from = Class,
              values_from = perc)

## 4 & 5. Average Conversion Rate
referral_outcome_ytd <- referral_vol %>%
  filter(createdYear == reporting_year) %>%
  filter(Class != "Outgoing") %>%
  group_by(ApptStatusFinal) %>%
  summarise(total = n()) %>%
  pivot_wider(names_from = ApptStatusFinal,
              values_from = total,
              values_fill = 0) %>%
  mutate(Scheduled = Canceled + `No Show` + Scheduled,
         Total = Arrived + Scheduled + Pending) %>%
  dplyr::select(-c(Canceled,`No Show`)) %>%
  mutate(conversion_rate = round((Arrived + Scheduled)/Total,2)*100,
         completion_rate = round(Arrived/Total,2)*100) 

## 6. Referrals Contacted/Scheduled <12 Hours
### Excludes "*Not Applicable" 
referral_contacted_ytd <- referral_vol %>%
  filter(createdYear == reporting_year) %>%
  filter(WasPatientContactedWithin12Hours_X %in% 
           c("Awaiting Contact Past 12 Hours","Appointment Scheduled Without Contact < 12 Hours",
             "Contacted Within 12 Hours", "Contacted After 12 Hours", "Appointment Scheduled Without Contact > 12 Hours")) %>%
  group_by(createdYear, WasPatientContactedWithin12Hours_X) %>%
  summarise(total = n()) %>%
  mutate(contacted_12hours = ifelse(WasPatientContactedWithin12Hours_X %in% 
           c("Appointment Scheduled Without Contact < 12 Hours","Contacted Within 12 Hours"), "Yes", "No")) %>%
  group_by(createdYear, contacted_12hours) %>%
  summarise(total = sum(total)) %>%
  mutate(perc = total/sum(total)) %>%
  filter(contacted_12hours == "Yes")

## 7. % Urgent Referrals Scheduled Within Priority Timeframe 
### Excludes "Not Specified" and "Patient Convenience" and CreationToFirstEncounterDate <0 days
referral_timeframe_ytd <- referral_vol %>%
  filter(createdYear == reporting_year) %>%
  filter(priority_type %!in% c("Not Specified", "Routine", "Patient Convenience")) %>%
  filter(CreationToFirstEncounterDate>=0) %>%
  group_by(createdYear, priority_type, CreationToFirstEncounterDate) %>%
  summarise(total = n()) %>%
  mutate(onTime = case_when(priority_type == "Within 2 Weeks" & CreationToFirstEncounterDate <= 14 ~ 'Yes',
                            priority_type == "Within 1 Week" &  CreationToFirstEncounterDate <= 7 ~ 'Yes',
                            priority_type == "Within 2 Days" &  CreationToFirstEncounterDate <= 2 ~ 'Yes',
                            TRUE ~ 'No')) %>%
  group_by(createdYear, onTime) %>%
  summarise(total = sum(total)) %>%
  pivot_wider(names_from = onTime,
              values_from = total) %>%
  mutate(perc = Yes/(No + Yes))
  


## % Referrals Aged (Fallen off from WQ)
referral_aged_ytd <- referral_vol %>%
  filter(createdYear == reporting_year) %>%
  mutate(referral_aged = case_when(referral_age >= 90 & referral_age < 180 & ApptStatusFinal == "Pending" ~ 'Yes', 
                                   TRUE ~ 'No')) %>%
  group_by(createdYear, referral_aged) %>% 
  summarise(total = n())


## 8. % of Referrals Rejected 
referral_redirected_ytd <- referral_vol %>%
  mutate(Redirected = ifelse(Redirected == 1, "Yes","No")) %>%
  group_by(createdYear, Redirected) %>%
  summarise(total = n()) %>%
  group_by(createdYear, Redirected) %>%
  summarise(total = sum(total)) %>%
  pivot_wider(names_from = Redirected,
              values_from = total) %>%
  mutate(perc = Yes/(No + Yes))
  

## 9. % of Referrals Redirected
referral_rejected_ytd <- referral_vol %>%
  mutate(Rejected = ifelse(Rejected == 1, "Yes","No")) %>%
  group_by(createdYear, Rejected) %>%
  summarise(total = n()) %>%
  group_by(createdYear, Rejected) %>%
  summarise(total = sum(total)) %>%
  pivot_wider(names_from = Rejected,
              values_from = total) %>%
  mutate(perc = Yes/(No + Yes))
  

```

```{r Sinai Logo, echo=FALSE, out.width = '30%'}
# knitr::include_graphics("Mount_Sinai_Logo_H.png")

```

# Ambulatory Referrals Summary
*Report run date: `r report_run_date`*<br/>
*Date source: * <br/>
_________________________________________________________________________________________________________________________________________________________________________________________________
<br/>

## MSHS
### 1. Snapshot {.tabset .tabset-fade .tabset-pills}
#### Referrals
```{r Referrals YTD Snapshot Output 1, echo = FALSE, warning = FALSE, message = FALSE,  results='hide', fig.width=12}
# Referrals YTD Snapshot ------------------------------------------------------- 
# referrals_ytd_snapshot <- data.frame(
# values =
#   c(prettyNum(referral_received_ytd$total, big.mark = ","),
#     paste0(paste0(referral_outcome_ytd$conversion_rate,"%")," | ", paste0(referral_outcome_ytd$completion_rate,"%")),
#     paste0("$",comprss(referral_est_rev_ytd$total_prof_charge_est + referral_est_rev_ytd$total_hosp_charge_est))), 
# 
# infos =
#   c("Total Referrals YTD",
#     "Conversion | Completion Rate",
#     "Est. Total Charges Generated\nfrom Completed Appointments"), 
# icons =
#   c("fa-gear", "fa-diamond", "fa-tasks")
# )
# 
# createValueBoxes(referrals_ytd_snapshot, "#212070", rows=1)
# 
# # Referral Outcome YRD Snapshot ------------------------------------------------------- 
# referrals_outcome_ytd_snapshot <- data.frame(
# values =
#   c(paste0(paste0(round(referral_vol_class_ytd$Incoming,3)*100,"%")," | ", paste0(round(referral_vol_class_ytd$Outgoing,3)*100,"%")),
#     paste0(round(referral_contacted_ytd$perc,2)*100,"%"),
#     paste0(round(referral_timeframe_ytd$perc,2)*100,"%")), 
#  
# infos =
#   c("% Incoming | Outgoing Referrals",
#     "% Referrals Contacted/Scheduled <12 Hours",
#     "% Referrals Scheduled On-Time YTD\nBased on Priority"), 
# icons =
#   c("fa-gear", "fa-diamond", "fa-tasks")
# )
# 
# createValueBoxes(referrals_outcome_ytd_snapshot, "#a5a7a5", rows=1)
# 
# # Expired Referrals YTD Snapshot ------------------------------------------------------- 
# referrals_expired_ytd_snapshot <- data.frame(
# values =
#   c(paste0(round(referral_expired_ytd$total / referral_outcome_ytd$Total,2)*100,"%"),
#     prettyNum(referral_expired_ytd$total, big.mark = ","),
#     paste0("$",comprss(referral_expired_ytd$total_prof_charge_est + referral_expired_ytd$total_hosp_charge_est))), 
# 
# infos =
#   c("% Referrals Expired YTD",
#     "Total Referrals Expired YTD",
#     "Est. Total Missed Charges\nDue to Expired Referrals"), 
# icons =
#   c("fa-gear", "fa-diamond", "fa-tasks")
# )
# 
# createValueBoxes(referrals_expired_ytd_snapshot, "#d80b8c", rows=1)

# Referrals YTD Snapshot Tables ------------------------------------------------
referrals_snapshot_1 <- data.frame(
  total = prettyNum(referral_received_ytd$total, big.mark = ","),
  blank_1 = "",
  rate = paste0(paste0(referral_outcome_ytd$conversion_rate,"%")," | ", paste0(referral_outcome_ytd$completion_rate,"%")),
  blank_2 = "",
  charges = paste0("$",comprss(referral_est_rev_ytd$total_prof_charge_est + referral_est_rev_ytd$total_hosp_charge_est))
)


reactable(
    referrals_snapshot_1,
    style = list(fontFamily = 'Calibri', fontSize = '32px'),
    defaultColDef = colDef(align = "center", 
                           headerStyle = list(fontWeight = "Bold", fontSize = "12px"),
                           headerClass = "bar-sort-header"),  
    highlight = TRUE,
    pagination = FALSE,
    wrap = TRUE,
    bordered = FALSE,
    theme = reactableTheme(
      stripedColor = "white"),
    columns = list(
      total = colDef(
        name = "Total Referrals YTD",
        minWidth = 300,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "20px"),
        style = list(fontWeight = "Bold", color = "white", background = "#212070"),
        align = "center"
        # footer = "*Excludes MSDD and NETWORK"
        ),
      blank_1 = colDef(
        name = "",
        maxWidth = 80
      ),
      rate = colDef(
        name = "Conversion | Completion Rate",
        minWidth = 300,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "20px"),
        style = list(fontWeight = "Bold", color = "white", background = "#212070"),
        align = "center"
        # footer = "*Excludes MSDD and NETWORK"
        ),
      blank_2 = colDef(
        name = "",
        maxWidth = 80
      ),
      charges = colDef(
        name = "Est. Total Charges Generated\nfrom Completed Appointments",
        minWidth = 300,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "20px"),
        style = list(fontWeight = "Bold", color = "white", background = "#212070"),
        align = "center"
        # footer = "*Excludes MSDD and NETWORK"
        )
    ) # Close Columns
  ) # Close Reactable

```


```{r Referrals YTD Snapshot Output 2, echo = FALSE, warning = FALSE, message = FALSE,  results='hide', fig.width=12}

# Referrals YTD Snapshot Tables ------------------------------------------------
referrals_snapshot_2 <- data.frame(
  class = paste0(paste0(round(referral_vol_class_ytd$Incoming,3)*100,"%")," | ", paste0(round(referral_vol_class_ytd$Outgoing,3)*100,"%")),
  blank_1 = "",
  contacted = paste0(round(referral_contacted_ytd$perc,2)*100,"%"),
  blank_2 = "",
  onTime = paste0(round(referral_timeframe_ytd$perc,2)*100,"%")
)

reactable(
    referrals_snapshot_2,
    style = list(fontFamily = 'Calibri', fontSize = '32px'),
    defaultColDef = colDef(align = "center", 
                           headerStyle = list(fontWeight = "Bold", fontSize = "12px"),
                           headerClass = "bar-sort-header"),  
    highlight = TRUE,
    pagination = FALSE,
    wrap = TRUE,
    bordered = FALSE,
    columns = list(
      class = colDef(
        name = "% Incoming | Outgoing Referrals",
        minWidth = 300,
        headerStyle = list(background = "#a5a7a5", color = "white", fontWeight = "Bold", fontSize = "20px"),
        style = list(fontWeight = "Bold", background = "#a5a7a5", color = "white"),
        align = "center"
        # footer = "*Excludes MSDD and NETWORK"
        ),
      blank_1 = colDef(
        name = "",
        maxWidth = 80
      ),
      contacted = colDef(
        name = "% Referrals Contacted/ Scheduled <12 Hours",
        minWidth = 300,
        headerStyle = list(background = "#a5a7a5", color = "white", fontWeight = "Bold", fontSize = "20px"),
        style = list(fontWeight = "Bold", background = "#a5a7a5", color = "white"),
        align = "center"
        # footer = "*Excludes MSDD and NETWORK"
        ),
      blank_2 = colDef(
        name = "",
        maxWidth = 80
      ),
      onTime = colDef(
        name = "% Referrals Scheduled On-Time YTD Based on Priority",
        minWidth = 300,
        headerStyle = list(background = "#a5a7a5", color = "white", fontWeight = "Bold", fontSize = "20px"),
        style = list(fontWeight = "Bold", background = "#a5a7a5", color = "white"),
        align = "center"
        # footer = "*Excludes MSDD and NETWORK"
        )
    ) # Close Columns
  ) # Close Reactable

```


```{r Referrals YTD Snapshot Output 3, echo = FALSE, warning = FALSE, message = FALSE,  results='hide', fig.width=12}

referrals_snapshot_3 <- data.frame(
  expired_cnt = prettyNum(referral_expired_ytd$total, big.mark = ","),
  blank_1 = "",
  expired_perc = paste0(round(referral_expired_ytd$total / referral_outcome_ytd$Total,2)*100,"%"),
  blank_2 = "",
  expired_charges = paste0("$",comprss(referral_expired_ytd$total_prof_charge_est + referral_expired_ytd$total_hosp_charge_est))
)

reactable(
    referrals_snapshot_3,
    style = list(fontFamily = 'Calibri', fontSize = '32px'),
    defaultColDef = colDef(align = "center", 
                           headerStyle = list(fontWeight = "Bold", fontSize = "12px"),
                           headerClass = "bar-sort-header"),  
    highlight = TRUE,
    pagination = FALSE,
    wrap = TRUE,
    bordered = TRUE,
    columns = list(
      expired_cnt = colDef(
        name = "Total Referrals Expired",
        minWidth = 300,
        headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "20px"),
        style = list(fontWeight = "Bold", background = "#d80b8c", color = "white"),
        align = "center"
        # footer = "*Excludes MSDD and NETWORK"
        ),
      blank_1 = colDef(
        name = "",
        maxWidth = 80
      ),
      expired_perc = colDef(
        name = "% Referrals Expired YTD",
        minWidth = 300,
        headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "20px"),
        style = list(fontWeight = "Bold", background = "#d80b8c", color = "white"),
        align = "center"
        # footer = "*Excludes MSDD and NETWORK"
        ),
      blank_2 = colDef(
        name = "",
        maxWidth = 80
      ),
      expired_charges = colDef(
        name = "Est. Total Missed Charges\nDue to Expired Referrals",
        minWidth = 300,
        headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "20px"),
        style = list(fontWeight = "Bold", background = "#d80b8c", color = "white"),
        align = "center"
        # footer = "*Excludes MSDD and NETWORK"
        )
    ) # Close Columns
  ) # Close Reactable


```

```{r YTD Top Sending Specialties, echo = FALSE, warning = FALSE, message = FALSE}
 
# Data for internal received specialties -------------------------
mshs_ytdReceived_internal_top <- referral_vol %>%
  filter(createdYear == reporting_year) %>%
  filter(createdMonNum != 11) %>%
  filter(Class == "Internal") %>%
  filter(ReceivedBySpecialty != "*Unspecified") %>%
  group_by(ReceivedBySpecialty, ApptStatusFinal) %>%
  summarise(total_internal = n()) %>%
  pivot_wider(names_from = ApptStatusFinal,
              values_from = total_internal,
              values_fill = 0) %>%
  mutate(Scheduled = Canceled + `No Show` + Scheduled,
         total_internal = Arrived + Scheduled + Pending) %>%
  dplyr::select(-c(Canceled,`No Show`)) %>%
  ungroup() %>%
  mutate(perc_internal = total_internal/sum(total_internal)) %>%
  mutate(conversion_rate_internal = round((Arrived + Scheduled)/total_internal,2),
         completion_rate_internal = round(Arrived/total_internal,2)) %>%
  dplyr::select(-c(Arrived,Scheduled,Pending)) %>%
  arrange(desc(total_internal)) %>%
  rename(`Internal Demand` = ReceivedBySpecialty)


mshs_ytdReceived_external_top <- referral_vol %>%
  filter(createdYear == reporting_year) %>%
  filter(createdMonNum != 11) %>%
  filter(Class == "Incoming") %>%
  filter(ReceivedBySpecialty != "*Unspecified") %>%
  group_by(ReceivedBySpecialty, ApptStatusFinal) %>%
  summarise(total_internal = n()) %>%
  pivot_wider(names_from = ApptStatusFinal,
              values_from = total_internal,
              values_fill = 0) %>%
  mutate(Scheduled = Canceled + `No Show` + Scheduled,
         total_external = Arrived + Scheduled + Pending) %>%
  dplyr::select(-c(Canceled,`No Show`)) %>%
  ungroup() %>%
  mutate(perc_external = total_external/sum(total_external)) %>%
  mutate(conversion_rate_external = round((Arrived + Scheduled)/total_external,2),
         completion_rate_external = round(Arrived/total_external,2)) %>%
  dplyr::select(-c(Arrived,Scheduled,Pending)) %>%
  arrange(desc(total_external)) %>%
  rename(`External Demand` = ReceivedBySpecialty)


# Table Output -----------------------------------------------------------------
mshs_ytdReceived_internal_top15 <- mshs_ytdReceived_internal_top [1:15,] %>%
  bind_rows(summarise(.,
                      across(where(is.numeric), sum),
                      across(where(is.character), ~"Total Internal Demand"))) %>%
  mutate(blank = "") 
mshs_ytdReceived_internal_top15[16, c("conversion_rate_internal")] <- NA
mshs_ytdReceived_internal_top15[16, c("completion_rate_internal")] <- NA


mshs_ytdReceived_external_top15 <- mshs_ytdReceived_external_top[1:15,] %>%
  bind_rows(summarise(.,
                      across(where(is.numeric), sum),
                      across(where(is.character), ~"Total External Demand"))) 
mshs_ytdReceived_external_top15[16, c("conversion_rate_external")] <- NA
mshs_ytdReceived_external_top15[16, c("completion_rate_external")] <- NA

ytd_demand_specialty_summary <- bind_cols(mshs_ytdReceived_internal_top15, mshs_ytdReceived_external_top15)


  # Table Output 
  reactable(
    ytd_demand_specialty_summary,
    # groupBy = c("Campus","Campus.Specialty"),
    # defaultPageSize = 5,
    # elementId = "site-grouping-table",
    style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "center", 
                           headerStyle = list(fontWeight = "Bold", fontSize = "12px"),
                           headerClass = "bar-sort-header"),  
    rowStyle = function(index) {
            if (index %in% c(16)) {
              list(`border-top` = "2px solid rgb(184,184,184)",
                   fontWeight = "Bold")
            }
          },
    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
    # bordered = TRUE,
     # rowStyle = function(index) {
     #        if (index %in% as.vector(col_border_num$total)) {
     #          list(`border-bottom` = "thin solid")
     #        }
     #      },
    columnGroups = list(
    colGroup(name = paste0("Internal Demand - Apr-Oct 2022"), 
             columns = c("Internal Demand", "total_internal", "perc_internal","conversion_rate_internal","completion_rate_internal"),
             headerStyle = list(color = "#d80b8c", fontSize = "24px")),
    colGroup(name = paste0("External Demand - Apr-Oct 2022"), 
             columns = c("External Demand", "total_external", "perc_external","conversion_rate_external","completion_rate_external"),
             headerStyle = list(color = "#00aeef", fontSize = "24px"))
    ),
    columns = list(
      `Internal Demand` = colDef(
        name = "Top 15 Specialties",
        maxWidth = 250,
        headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
        style = list(fontWeight = "Bold"),
        align = "left"
        # footer = "*Excludes MSDD and NETWORK"
        ),
      total_internal = colDef(
        name = "Total Internal Referrals", align = "left", 
        headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
        style = function(value) {
        if(value > max(mshs_ytdReceived_internal_top$total_internal)) {
            bar_style(width = 0, fill = "hsl(208, 70%, 90%)")
          } else{
            bar_style(width = value / max(mshs_ytdReceived_internal_top$total_internal), fill = "hsl(321, 87%, 85%)")
          } 
          },
        format = colFormat(separators = TRUE)
        ),
      perc_internal = colDef(
        name = "% of Total Internal Referrals",
        maxWidth = 120,
        headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(percent = TRUE, digits = 1)
      ),
      conversion_rate_internal = colDef(
        name = "Conversion Rate",
        align = 'center', 
        maxWidth = 100,
        headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
        format = colFormat(percent = TRUE, digits = 0),
        style = function(value) {
          # Lighter color for <1%
          if (is.na(value)) {
            list(color = "#aaa")
            } else {
              list(color = "#111", background = pct_color_GnRd(value))
            }
        }),
      completion_rate_internal = colDef(
        name = "Completion Rate",
        align = 'center', 
        maxWidth = 100,
        headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
        format = colFormat(percent = TRUE, digits = 0),
        style = function(value) {
          # Lighter color for <1%
          if (is.na(value)) {
            list(color = "#aaa")
            } else {
              list(color = "#111", background = pct_color_GnRd(value))
            }
        }),
       blank = colDef(
        name = "",
        maxWidth = 30
      ),
      `External Demand` = colDef(
        name = "Top 15 Specialties",
        maxWidth = 250,
       headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"),
        style = list(fontWeight = "Bold"),
        align = "left"
        # footer = "*Excludes MSDD and NETWORK"
        ),
      total_external = colDef(
        name = "Total External Referrals", align = "left", 
        headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"),
        style = function(value) {
          if(value > max(mshs_ytdReceived_external_top$total_external)) {
            bar_style(width = 0, fill = "hsl(208, 70%, 90%)")
          } else{
            bar_style(width = value / max(mshs_ytdReceived_external_top$total_external), fill = "hsl(196, 100%, 85%)")
          } 
          },
        format = colFormat(separators = TRUE)
        ),
      perc_external = colDef(
        name = "% of Total External Referrals",
        maxWidth = 120,
        headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(percent = TRUE, digits = 1)
      ),
      conversion_rate_external = colDef(
        name = "Conversion Rate",
        align = 'center', 
        maxWidth = 100,
        headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"),
        format = colFormat(percent = TRUE, digits = 0),
        style = function(value) {
          # Lighter color for <1%
          if (is.na(value)) {
            list(color = "#aaa")
            } else {
              list(color = "#111", background = pct_color_GnRd(value))
            }
        }),
      completion_rate_external = colDef(
        name = "Completion Rate",
        align = 'center', 
        maxWidth = 100,
        headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"),
        format = colFormat(percent = TRUE, digits = 0),
        style = function(value) {
          # Lighter color for <1%
          if (is.na(value)) {
            list(color = "#aaa")
            } else {
              list(color = "#111", background = pct_color_GnRd(value))
            }
        })
      
      
      
    ) # Close Columns
  ) # Close Reactable

  
```


```{r Monthly Volume Trending, echo = FALSE, warning = FALSE, message = FALSE, fig.width=13, fig.align='center'}

# MSHS Referrals Received + Conversion and Completion Rate ---------------------
referral_received_monthly_mshs <- referral_vol %>%
  group_by(createdMonthYear, ApptStatusFinal) %>%
  summarise(total = n()) %>%
  pivot_wider(names_from = ApptStatusFinal,
              values_from = total,
              values_fill = 0) %>%
  mutate(Scheduled = Canceled + `No Show` + Scheduled,
         Total = Arrived + Scheduled + Pending) %>%
  dplyr::select(-c(Canceled,`No Show`)) %>%
  mutate(conversion_rate = round((Arrived + Scheduled)/Total,2)*100,
         completion_rate = round(Arrived/Total,2)*100) %>%
  arrange(createdMonthYear)

hchart(referral_received_monthly_mshs, 
       hcaes(x = createdMonthYear, y = Total), name = "Total Referrals Created",
       type = 'column',
       color='#212070',
       dataLabels = list(enabled = TRUE, format='{point.y}'), 
       showInLegend = TRUE) %>%
  hc_yAxis_multiples(
    list(title = list(text = "Total Referrals Created"), lineWidth = 3),
    list(title = list(text = "% of Total Referrals Created"), labels = list(enabled = TRUE, format='{value}%'), showLastLabel = FALSE, opposite = TRUE)
    ) %>%
  hc_xAxis(title = list(text = ""),
           categories = referral_received_monthly_mshs$createdMonthYear,
           type = "datetime",
           # labels = list(format = '{value:%m/%d}')
           dateTimeLabelFormats = list(month = '%Y-%m')
           ) %>%
  hc_add_series(name = "Conversion Rate",
                data = referral_received_monthly_mshs$conversion_rate,
                type = "line", yAxis = 1,
                color='#00aeef',
                lineColor='#00aeef',
                dashStyle = "shortdash",
                dataLabels = list(enabled = TRUE, format='{point.y}%'),
                showInLegend = TRUE) %>%
  hc_add_series(name = "Completion Rate",
                data = referral_received_monthly_mshs$completion_rate,
                type = "line", yAxis = 1,
                color='#d80b8c',
                lineColor='#d80b8c',
                dataLabels = list(enabled = TRUE, format='{point.y}%'),
                showInLegend = TRUE) %>%
  hc_legend(align = "left", verticalAlign = "top", itemStyle = list(fontFamily ='Calibri',color ='black', fontSize = "14px")) %>%
  hc_title(text = "MSHS Referral Volume and Outcome", align = "left", style = list(fontWeight = 'bold', fontSize = "22px", fontFamily = "Calibri")) %>%
  hc_subtitle(text = paste0("Based on referrals created from ","2022-04-01"," to ",report_run_date),
              align = "left", style = list(fontFace = "italic", fontSize = "16px", fontFamily = "Calibri")) %>%
  hc_tooltip(shared = TRUE, borderColor = "black")


# Site Referrals Received + Conversion and Completion Rate ---------------------
# referral_monthly_site <- referral_vol %>%
#   group_by(createdMonthYear, SentBySite, ApptStatusFinal) %>%
#   summarise(total = n()) %>%
#   pivot_wider(names_from = ApptStatusFinal,
#               values_from = total,
#               values_fill = 0) %>%
#   mutate(Scheduled = Canceled + `No Show` + Scheduled,
#          Total = Arrived + Scheduled + Pending) %>%
#   dplyr::select(-c(Canceled,`No Show`)) %>%
#   mutate(conversion_rate = (Arrived + Scheduled)/Total,
#          completion_rate = Arrived/Total) 

```


```{r YTD Snapshot WQ, echo = FALSE, warning = FALSE, message = FALSE}

## Current WQ Volume
current_wq_vol <- wq_reasons_raw %>%
  # filter(wq_type %in% c("TO","FROM")) %>%
  group_by(wq_type, reason_type) %>%
  summarise(total = n())

## Current Median Days in WQ
current_wq_days <- wq_reasons_raw %>%
  group_by(wq_type) %>%
  summarise(med_days_wq = median(days_wq))

## Current Median Days Since Referral Created
current_wq_days_creation <- wq_reasons_raw %>%
  group_by(wq_type) %>%
  summarise(med_days_creation = median(days_since_creation))

## Current % of Referrals Contacted/Scheduled <12 Hours
current_wq_contacted <- wq_reasons_raw %>%
  filter(WasPatientContactedWithin12Hours_X %!in% c("Awaiting Contact Still < 12 Hours")) %>%
  mutate(contacted_12hours = case_when(WasPatientContactedWithin12Hours_X %in% c("Contacted Within 12 Hours","Appointment Scheduled Without Contact < 12 Hours") 
                                       ~ "Yes",
                                       TRUE ~ "No")) %>%
  group_by(contacted_12hours) %>%
  summarise(total = n()) %>%
  mutate(perc = total/sum(total))


## Current % of Urgent Referrals (Within 2 Days)
current_wq_urgent <- wq_reasons_raw %>%
  group_by(priority_type) %>%
  summarise(total = n()) %>%
  ungroup() %>%
  mutate(perc = total/sum(total))

## Current Total Referral within 7 Days of Aging
current_wq_aging <- wq_reasons_raw %>%
  summarise(aging_7days = sum(days_wq >= 23))

## Past Week: Average Daily Volume Added 
wq_vol_added_week <- wq_volume_data %>%
  filter(wq_enteredWeek == reporting_week) %>%
  group_by(ReferralType, wq_entered, wq_enteredDay) %>%
  summarise(total = n()) 

## Past Week: Average Daily Volume Removed
wq_vol_removed_week <- wq_volume_data %>%
  filter(wq_exitedWeek == reporting_week) %>%
  group_by(ReferralType, wq_exited, wq_exitedDay) %>%
  summarise(total = n()) 

## Past Week: Total Aged Volume
# wq_vol_aging_week <- wq_volume_data %>%
#   filter(wq_exitedWeek == reporting_week) %>%
#   group_by(ReferralType, wq_exited, wq_exitedDay) %>%
#   summarise(total = n()) 

## Past Week: Total Exp Volume
# wq_vol_expired_week <- wq_volume_data %>%
#   filter(wq_exitedWeek == reporting_week) %>%
#   group_by(ReferralType, wq_exited, wq_exitedDay) %>%
#   summarise(total = n()) 

```


#### Workqueues
```{r WQ Snapshot Output 1, echo = FALSE, warning = FALSE, message = FALSE, results='hide'}

# Outstanding WQ Snapshot ------------------------------------------------------- 
## First Row
# current_wq_snapshot <- data.frame(
# values =
#   c(prettyNum(sum((current_wq_vol %>% filter(wq_type != ""))$total), big.mark = ","), # Excludes undefined WQ Type (Includes TO, FROM, AUTHORIZATION, TRIAGE, PAS)
#     paste0(as.numeric(median(wq_reasons_raw$days_wq)), " days"),
#     paste0(as.numeric(median(wq_reasons_raw$days_since_creation)), " days")), 
# 
# infos =
#   c(paste0("Total WQ Volume\nas of ",Sys.Date()),
#     "Median Days in WQ",
#     "Median Days since Referral Created"), 
# icons =
#   c("fa-gear", "fa-diamond", "fa-tasks")
# )
# 
# createValueBoxes(current_wq_snapshot , "#212070", rows=1)
# 
# ## Second Row
# current_wq_snapshot_2 <- data.frame(
# values =
#   c(paste0(round(current_wq_contacted[which(current_wq_contacted$contacted_12hours == "Yes"), "perc"],2)*100,"%"),
#     paste0(round(current_wq_urgent[which(current_wq_urgent$priority_type == "Within 2 Days"), "perc"],2)*100,"%"),
#     prettyNum(current_wq_aging$aging_7days, big.mark = ",")), 
# 
# infos =
#   c("% Referrals Contacted/ Scheduled <12 Hours\n*Excludes Awaiting Contact Still < 12 Hours",
#     "% Urgent Referrals in Workqueue",
#     "Total Referrals within 7 Days of Aging"), 
# icons =
#   c("fa-gear", "fa-tasks", "fa-tasks")
# )
# 
# createValueBoxes(current_wq_snapshot_2 , "#212070", rows=1)
# 
# # Past Week WQ Summary ---------------------------------------------------------
# past_week_wq_snapshot <- data.frame(
# values =
#   c(prettyNum(wq_vol_added_week %>% filter(wq_enteredDay %!in% c("Saturday","Sunday")) %>% ungroup() %>% summarise(avg = round(mean(total))), big.mark = ","),
#     prettyNum(wq_vol_removed_week %>% filter(wq_exitedDay %!in% c("Saturday","Sunday")) %>% ungroup() %>% summarise(avg = round(mean(total))), big.mark = ","),
#     prettyNum(wq_vol_added_week %>% filter(wq_enteredDay %in% c("Saturday","Sunday")) %>% ungroup() %>% summarise(avg = sum(total)), big.mark = ",")),
# 
# infos =
#   c("Avg Referrals Added per Weekday",
#     "Avg Referrals Removed per Weekday",
#     "Total Referrals Added during Weekend"), 
# icons =
#   c("fa-gear", "fa-diamond", "fa-tasks")
# )
# 
# createValueBoxes(past_week_wq_snapshot , "#a5a7a5", rows=1)
# 
# past_week_wq_snapshot_2 <- data.frame(
# values =
#   c(prettyNum(wq_vol_added_week %>% filter(wq_enteredDay %!in% c("Saturday","Sunday")) %>% ungroup() %>% summarise(avg = round(mean(total))), big.mark = ","),
#     prettyNum(wq_vol_added_week %>% filter(wq_enteredDay %in% c("Saturday","Sunday")) %>% ungroup() %>% summarise(avg = sum(total)), big.mark = ",")),
# 
# infos =
#   c("Total Referrals Aged",
#     "Total Referrals Expired"), 
# icons =
#   c("fa-gear", "fa-diamond")
# )
# 
# createValueBoxes(past_week_wq_snapshot_2 , "#a5a7a5", rows=1)


# Workqueue YTD Snapshot Tables ------------------------------------------------
wq_snapshot_1 <- data.frame(
  total = prettyNum(sum((current_wq_vol %>% filter(wq_type != ""))$total), big.mark = ","),
  blank_1 = "",
  wq_days = paste0(as.numeric(median(wq_reasons_raw$days_wq)), " days"),
  blank_2 = "",
  referral_days = paste0(as.numeric(median(wq_reasons_raw$days_since_creation)), " days")
)


reactable(
    wq_snapshot_1,
    style = list(fontFamily = 'Calibri', fontSize = '32px'),
    defaultColDef = colDef(align = "center", 
                           headerStyle = list(fontWeight = "Bold", fontSize = "12px"),
                           headerClass = "bar-sort-header"),  
    highlight = TRUE,
    pagination = FALSE,
    wrap = TRUE,
    bordered = TRUE,
    columns = list(
      total = colDef(
        name = paste0("Total WQ Volume\nas of ",Sys.Date()),
        minWidth = 300,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "20px"),
        style = list(fontWeight = "Bold", background = "#212070", color = "white"),
        align = "center"
        # footer = "*Excludes MSDD and NETWORK"
        ),
      blank_1 = colDef(
        name = "",
        maxWidth = 80
      ),
      wq_days = colDef(
        name = "Median Days in Workqueue",
        minWidth = 300,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "20px"),
        style = list(fontWeight = "Bold", background = "#212070", color = "white"),
        align = "center"
        # footer = "*Excludes MSDD and NETWORK"
        ),
      blank_2 = colDef(
        name = "",
        maxWidth = 80
      ),
      referral_days = colDef(
        name = "Median Days since Referral Created",
        minWidth = 300,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "20px"),
        style = list(fontWeight = "Bold", background = "#212070", color = "white"),
        align = "center"
        # footer = "*Excludes MSDD and NETWORK"
        )
    ) # Close Columns
  ) # Close Reactable


```



```{r WQ Snapshot Output 2, echo = FALSE, warning = FALSE, message = FALSE, results='hide'}

# Workqueue YTD Snapshot Tables ------------------------------------------------
wq_snapshot_2 <- data.frame(
  urgent =  paste0(round(current_wq_urgent[which(current_wq_urgent$priority_type == "Within 2 Days"), "perc"],2)*100,"%"),
  blank_1 = "",
  contacted = paste0(round(current_wq_contacted[which(current_wq_contacted$contacted_12hours == "Yes"), "perc"],2)*100,"%"),
  blank_2 = "",
  aging = prettyNum(current_wq_aging$aging_7days, big.mark = ",")
)


reactable(
    wq_snapshot_2,
    style = list(fontFamily = 'Calibri', fontSize = '32px'),
    defaultColDef = colDef(align = "center", 
                           headerStyle = list(fontWeight = "Bold", fontSize = "12px"),
                           headerClass = "bar-sort-header"),  
    highlight = TRUE,
    pagination = FALSE,
    wrap = TRUE,
    bordered = TRUE,
    columns = list(
      urgent = colDef(
        name = "% Urgent Referrals in Workqueue",
        minWidth = 300,
        headerStyle = list(background = "#a5a7a5", color = "white", fontWeight = "Bold", fontSize = "20px"),
        style = list(fontWeight = "Bold", background = "#a5a7a5", color = "white"),
        align = "center"
        # footer = "*Excludes MSDD and NETWORK"
        ),
      blank_1 = colDef(
        name = "",
        maxWidth = 80
      ),
      contacted = colDef(
        name = "% Referrals Contacted/ Scheduled <12 Hours\n(Excludes Awaiting Contact Still < 12 Hours)",
        minWidth = 300,
        headerStyle = list(background = "#a5a7a5", color = "white", fontWeight = "Bold", fontSize = "20px"),
        style = list(fontWeight = "Bold", background = "#a5a7a5", color = "white"),
        align = "center"
        ),
      blank_2 = colDef(
        name = "",
        maxWidth = 80
      ),
      aging = colDef(
        name = "Total Referrals within 7 Days of Aging",
        minWidth = 300,
        headerStyle = list(background = "#a5a7a5", color = "white", fontWeight = "Bold", fontSize = "20px"),
        style = list(fontWeight = "Bold", background = "#a5a7a5", color = "white"),
        align = "center"
        # footer = "*Excludes MSDD and NETWORK"
        )
    ) # Close Columns
  ) # Close Reactable


```


```{r WQ Snapshot Output 3, echo = FALSE, warning = FALSE, message = FALSE, results='hide'}

# Outstanding WQ Snapshot ------------------------------------------------------- 

wq_snapshot_3 <- data.frame(
  wq_added = prettyNum(wq_vol_added_week %>% filter(wq_enteredDay %!in% c("Saturday","Sunday")) %>% ungroup() %>% summarise(avg = round(mean(total))), big.mark = ","),
  blank_1 = "",
  wq_removed = prettyNum(wq_vol_removed_week %>% filter(wq_exitedDay %!in% c("Saturday","Sunday")) %>% ungroup() %>% summarise(avg = round(mean(total))), big.mark = ","),
  blank_2 = "",
  wq_added_wknd = prettyNum(wq_vol_added_week %>% filter(wq_enteredDay %in% c("Saturday","Sunday")) %>% ungroup() %>% summarise(avg = sum(total)), big.mark = ",")
)
rownames(wq_snapshot_3) <- NULL

reactable(
    wq_snapshot_3,
    style = list(fontFamily = 'Calibri', fontSize = '32px'),
    defaultColDef = colDef(align = "center", 
                           headerStyle = list(fontWeight = "Bold", fontSize = "12px"),
                           headerClass = "bar-sort-header"),  
    highlight = TRUE,
    pagination = FALSE,
    wrap = TRUE,
    bordered = TRUE,
    columns = list(
      wq_added = colDef(
        name = "Avg Referrals Added per Weekday",
        minWidth = 300,
        headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "20px"),
        style = list(fontWeight = "Bold", background = "#d80b8c", color = "white"),
        align = "center"
        # footer = "*Excludes MSDD and NETWORK"
        ),
      blank_1 = colDef(
        name = "",
        maxWidth = 80
      ),
      wq_removed = colDef(
        name = "Avg Referrals Removed per Weekday",
        minWidth = 300,
        headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "20px"),
        style = list(fontWeight = "Bold", background = "#d80b8c", color = "white"),
        align = "center"
        # footer = "*Excludes MSDD and NETWORK"
        ),
      blank_2 = colDef(
        name = "",
        maxWidth = 80
      ),
      wq_added_wknd = colDef(
        name = "Total Referrals Added during Weekend",
        minWidth = 300,
        headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "20px"),
        style = list(fontWeight = "Bold", background = "#d80b8c", color = "white"),
        align = "center"
        # footer = "*Excludes MSDD and NETWORK"
        )
    ) # Close Columns
  ) # Close Reactable


```


```{r Monthly Resolution Rate, echo = FALSE, warning = FALSE, message = FALSE}



```


### 2. ED Referrals

```{r Average ED Referrals per Patient, echo = FALSE, warning = FALSE, message = FALSE, fig.width=13, fig.align='center'}

referral_per_patient <- referral_vol %>%
  mutate(ed = ifelse(SentBySite %in% c("ED","PSYCH ED"), "ED Referrals", "Non-ED Referrals")) %>%
  group_by(createdMonthYear, ed) %>%
  summarise(total = n(),
            unique_pts = length(unique(Patient_MRN))) %>%
  mutate(avg_ref_pt = round(total/unique_pts,2))


hchart(referral_per_patient, 
       hcaes(x = 'createdMonthYear', y = 'total', group = 'ed'), 
       type = 'column',
       stacking = "normal",
       color=c("#a5a7a5", "#212070"),
       dataLabels = list(enabled = TRUE, format='{value:,f}'), 
       showInLegend = TRUE) %>%
  hc_yAxis_multiples(
    list(title = list(text = "Total Referrals Created"), lineWidth = 3),
    list(title = list(text = "Avg Referrals per Patient"), labels = list(enabled = TRUE, format='{value}'), showLastLabel = FALSE, opposite = TRUE)
    ) %>%
  hc_xAxis(title = list(text = ""),
           categories = referral_per_patient$createdMonthYear,
           type = "datetime",
           # labels = list(format = '{value:%m/%d}')
           dateTimeLabelFormats = list(month = '%Y-%m')
           ) %>%
  hc_add_series(name = "ED Avg Referrals per Patient",
                data = (referral_per_patient %>% filter(ed == "ED Referrals"))$avg_ref_pt,
                type = "line", yAxis = 1,
                color='#00aeef',
                lineColor='#00aeef',
                dashStyle = "shortdash",
                dataLabels = list(enabled = TRUE, format='{point.y}'),
                showInLegend = TRUE) %>%
  hc_add_series(name = "Non-ED Avg Referrals per Patient ",
                data = (referral_per_patient %>% filter(ed == "Non-ED Referrals"))$avg_ref_pt,
                type = "line", yAxis = 1,
                color='#d80b8c',
                lineColor='#d80b8c',
                dataLabels = list(enabled = TRUE, format='{point.y}'),
                showInLegend = TRUE) %>%
  hc_legend(align = "left", verticalAlign = "top", itemStyle = list(fontFamily ='Calibri',color ='black', fontSize = "14px")) %>%
  hc_title(text = "ED vs. Non-ED Average Referrals per Patient", align = "left", style = list(fontWeight = 'bold', fontSize = "22px", fontFamily = "Calibri")) %>%
  # hc_subtitle(text = paste0("Based on referrals created from ","2022-04-01"," to ",report_run_date),
  #             align = "left", style = list(fontFace = "italic", fontSize = "16px", fontFamily = "Calibri")) %>%
  hc_tooltip(shared = TRUE, borderColor = "black")

```

#### Total ED Referrals by Scheduling Priority 
```{r ED Referrals Total Volume by Priority, echo = FALSE, warning = FALSE, message = FALSE, fig.width=13, fig.align='center'}

ed_vol_priority_cnt <- referral_vol %>%
  filter(SentBySite %in% c("ED","PSYCH ED")) %>%
  group_by(createdMonthYear, priority_type) %>%
  summarise(total = n()) %>%
  pivot_wider(names_from = createdMonthYear,
              values_from = total) %>%
  mutate_if(is.integer, as.numeric) %>%
  bind_rows(summarise(.,
                      across(where(is.numeric), sum),
                      across(where(is.character), ~"Total"))) %>%
  arrange(factor(priority_type, levels = c('Within 2 Days', 'Within 1 Week', 'Within 2 Weeks', 'Patient Convenience', 'Not Specified', 'Total')))


ed_vol_priority_cnt <- as.data.frame(ed_vol_priority_cnt)
rownames(ed_vol_priority_cnt) <- ed_vol_priority_cnt$priority_type
ed_vol_priority_cnt  <- ed_vol_priority_cnt[,-1]

BuYlRd <- function(x) rgb(colorRamp(c("#7fb7d7", "#ffffbf", "#fc8d59")) 
(x), maxColorValue = 255)

reactable(
  ed_vol_priority_cnt,
  style = list(fontFamily = 'Calibri', fontSize = 'px14'),
    highlight = TRUE,
    pagination = FALSE,
    wrap = TRUE,
    bordered = TRUE,
  
  defaultColDef = colDef(
    style = function(value) {
      if (!is.numeric(value)) return()
      normalized <- (value - min(ed_vol_priority_cnt)) / (max(ed_vol_priority_cnt) - min(ed_vol_priority_cnt))
      color <- BuYlRd(normalized)
      list(background = color, fontWeight = "Bold")
    },
    format = colFormat(digits = 0, separators = TRUE),
    align = "center",
    minWidth = 50
  ),
  columns = list(
    .rownames = colDef(name = "Referral Scheduling Priority", sortable = TRUE, align ="left", minWidth = 100)
  )
)

```


#### % of ED Referrals by Scheduling Priority 
```{r Percent of ED Referrals by Scheduling Priority, echo = FALSE, warning = FALSE, message = FALSE, fig.width=13, fig.align='center'}

ed_vol_priority_perc <- referral_vol %>%
  filter(SentBySite %in% c("ED","PSYCH ED")) %>%
  group_by(createdMonthYear, priority_type) %>%
  summarise(total = n()) %>%
  group_by(createdMonthYear) %>%
  mutate(perc = total/sum(total)) %>%
  dplyr::select(-total) %>%
  pivot_wider(names_from = createdMonthYear,
              values_from = perc) %>%
  arrange(factor(priority_type, levels = c('Within 2 Days', 'Within 1 Week', 'Within 2 Weeks', 'Patient Convenience', 'Not Specified')))

ed_vol_priority_perc <- as.data.frame(ed_vol_priority_perc)
rownames(ed_vol_priority_perc) <- ed_vol_priority_perc$priority_type
ed_vol_priority_perc  <- ed_vol_priority_perc[,-1]

reactable(
  ed_vol_priority_perc,
  style = list(fontFamily = 'Calibri', fontSize = 'px14'),
    highlight = TRUE,
    pagination = FALSE,
    wrap = TRUE,
    bordered = TRUE,
  
  defaultColDef = colDef(
    style = function(value) {
      if (!is.numeric(value)) return()
      normalized <- (value - min(ed_vol_priority_perc)) / (max(ed_vol_priority_perc) - min(ed_vol_priority_perc))
      color <- BuYlRd(normalized)
      list(background = color, fontWeight = "Bold")
    },
    format = colFormat(digits = 0, percent = TRUE),
    align = "center",
    minWidth = 50
  ),
  columns = list(
    .rownames = colDef(name = "Referral Scheduling Priority", sortable = TRUE, align ="left", minWidth = 100)
  )
) 

```

